<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login - Topic Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="login-container">
    <h1>Topic Tracker</h1>
    <p class="subtitle">Classify exam questions by topic</p>

    <div class="login-box">
      <div class="section">
        <label for="emailInput">Email</label>
        <input type="email" id="emailInput" placeholder="Enter your email" />
      </div>

      <div class="section">
        <button id="magicLinkBtn" class="btn-primary">Send Login Link</button>
      </div>

      <div class="divider">
        <span>or</span>
      </div>

      <div class="section">
        <button id="googleBtn" class="btn-google">Sign in with Google</button>
      </div>

      <div class="section guest-link">
        <a href="/classify" id="guestLink">Continue as Guest</a>
      </div>
    </div>

    <div id="loginStatus" class="login-status"></div>
  </div>

  <script type="module">
    import {
      getCurrentUser,
      signInWithMagicLink,
      signInWithGoogle,
      onAuthChange,
    } from "/static/shared/auth.js";
    import { migrateGuestSessions } from "/static/shared/api.js";

    const emailInput = document.getElementById("emailInput");
    const magicLinkBtn = document.getElementById("magicLinkBtn");
    const googleBtn = document.getElementById("googleBtn");
    const loginStatus = document.getElementById("loginStatus");

    // Check if already logged in
    async function checkExistingSession() {
      const user = await getCurrentUser();
      if (user) {
        // User is already logged in, migrate any guest sessions and redirect
        try {
          await migrateGuestSessions();
        } catch (e) {
          console.error("Migration error:", e);
        }
        window.location.href = "/classify";
      }
    }

    checkExistingSession();

    // Listen for auth state changes (e.g., after magic link callback)
    onAuthChange(async (user, event) => {
      if (user && event === "SIGNED_IN") {
        loginStatus.textContent = "Logged in! Migrating sessions...";
        try {
          const result = await migrateGuestSessions();
          if (result.migrated > 0) {
            loginStatus.textContent = `Migrated ${result.migrated} session(s). Redirecting...`;
          }
        } catch (e) {
          console.error("Migration error:", e);
        }
        window.location.href = "/classify";
      }
    });

    // Magic link login
    magicLinkBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      if (!email) {
        alert("Please enter an email!");
        return;
      }

      magicLinkBtn.disabled = true;
      googleBtn.disabled = true;
      loginStatus.textContent = "Sending magic link...";

      const { error } = await signInWithMagicLink(email);

      if (error) {
        console.error("Error sending magic link:", error);
        loginStatus.textContent = "Failed to send magic link. Please try again.";
        magicLinkBtn.disabled = false;
        googleBtn.disabled = false;
      } else {
        loginStatus.textContent = "Magic link sent! Check your email.";
      }
    });

    // Google login
    googleBtn.addEventListener("click", async () => {
      magicLinkBtn.disabled = true;
      googleBtn.disabled = true;
      loginStatus.textContent = "Redirecting to Google...";

      const { error } = await signInWithGoogle();

      if (error) {
        console.error("Google login error:", error);
        loginStatus.textContent = "Google login failed. Please try again.";
        magicLinkBtn.disabled = false;
        googleBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
